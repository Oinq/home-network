# üß± Immich ‚Äî Instala√ß√£o e Diagn√≥stico (v1.137.1 ‚Üí v2.2.x)

## üîπ Contexto

**Host:** `oinqserver` (HP Microserver Gen8, Ubuntu 24.04.2 LTS)  
**Stack:** Docker Compose  
**Rede:** 192.168.1.x  
**Storage:**
- `/mnt/raid/containers/immich/upload` ‚Üí volume local para cache / encoded-video / thumbs  
- `/mnt/nas_media/media` ‚Üí montado CIFS read-only em `/ext` (NAS principal)

**Objetivo:** verificar integridade e espa√ßo do sistema atual, e preparar atualiza√ß√£o segura para Immich **v2.2.3**.

---

## üîπ Diagn√≥stico inicial

1. **Containers saud√°veis:**
   ```bash
   docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | grep immich
   ```
   Resultado:
   ```
   immich_server             Up (healthy)
   immich_machine_learning   Up (healthy)
   immich_postgres           Up (healthy)
   immich_redis              Up (healthy)
   ```

2. **Verifica√ß√£o de montagens internas:**
   ```bash
   docker exec -it immich_server bash -lc '
   echo "-- /data"; ls -al /data
   echo "-- /ext mount"; mount | grep " on /ext "
   '
   ```
   ‚úÖ `/data` cont√©m subdiret√≥rios `upload`, `encoded-video`, `library`, `thumbs`, `backups`, `profile`  
   ‚úÖ `.immich` markers criados em cada pasta  
   ‚úÖ `/ext` montado via CIFS (NAS RO) ‚Üí `/data/encoded-video` √© local, n√£o NAS.

3. **Espa√ßo reportado no dashboard:**
   ```
   Utilizado 105 GiB de 8.1 TiB
   ```
   ‚ûú refere-se ao **disco local (upload)**, n√£o ao NAS.

---

## üîπ Testes de conte√∫do

1. **Mapeamentos verificados:**
   ```bash
   docker inspect immich_server --format '{{json .Mounts}}' | jq .
   ```
   ```
   /mnt/raid/containers/immich/upload ‚Üí /data
   /mnt/nas_media/media ‚Üí /ext (ro)
   ```

2. **Conte√∫do acess√≠vel:**
   ```bash
   docker exec -it immich_server bash -lc '
   ls -al /ext/photos | head
   find /ext/photos -maxdepth 3 -type d | head -n 100
   find /ext/videoteca -maxdepth 3 -type f | head -n 20
   '
   ```
   ‚ûú Confirmado acesso aos ficheiros e diret√≥rios esperados (ex: `photos/`, `videoteca/`).

---

## üîπ Base de dados e servi√ßos

Verifica√ß√µes cruzadas:
```bash
# Postgres
docker run --rm --network immich_default --env-file /mnt/raid/immich/config/.env \
  ghcr.io/immich-app/postgres:14-vectorchord0.4.3-pgvectors0.2.0 \
  bash -lc 'pg_isready -h immich_postgres -U "$DB_USERNAME" -d "$DB_DATABASE_NAME"'

# Redis/Valkey
docker run --rm --network immich_default valkey/valkey:8-bookworm \
  bash -lc 'redis-cli -h immich_redis ping'
```
Resultados:  
‚úÖ Postgres OK  
‚úÖ Redis respondeu `PONG`

---

## üîπ Prepara√ß√£o para atualiza√ß√£o

**Vers√£o atual:**
```bash
grep ^IMMICH_VERSION /mnt/raid/immich/config/.env
‚Üí IMMICH_VERSION=release
```

**√öltima release est√°vel:** `v2.2.3` (Nov 2025)  
Compara√ß√£o de commits mostra grandes mudan√ßas estruturais e UI overhaul.

---

## üîπ Plano de atualiza√ß√£o seguro

1. **Backup completo**
   ```bash
   mkdir -p /mnt/raid/immich/backups/$(date +%F)
   docker compose -f /mnt/raid/immich/config/docker-compose.yml down
   docker cp immich_postgres:/var/lib/postgresql/data /mnt/raid/immich/backups/$(date +%F)/postgres_data
   cp -a /mnt/raid/immich/config /mnt/raid/immich/backups/$(date +%F)/config
   cp -a /mnt/raid/containers/immich/upload /mnt/raid/immich/backups/$(date +%F)/upload_meta
   ```

2. **Fixar vers√£o v2.2.3**
   ```bash
   sed -i 's/^IMMICH_VERSION=.*/IMMICH_VERSION=v2.2.3/' /mnt/raid/immich/config/.env
   ```

3. **Atualizar containers**
   ```bash
   docker compose -f /mnt/raid/immich/config/docker-compose.yml pull
   docker compose -f /mnt/raid/immich/config/docker-compose.yml up -d
   ```

4. **Verificar migra√ß√£o de base de dados**
   ```bash
   docker logs -f immich_server | grep -i migration
   ```

5. **Confirmar no UI**
   - Dashboard ‚Üí canto inferior direito ‚Üí `v2.2.3`
   - Admin ‚Üí Database Schema ‚Üí ‚ÄúUp to date‚Äù

---

## üîπ Notas importantes

- A v2.x introduz novo motor de sincroniza√ß√£o, OCR, permiss√µes refinadas e nova interface.  
- As bibliotecas em `/ext` continuam montadas **read-only** (NAS externo).  
- O contador ‚ÄúEspa√ßo de armazenamento‚Äù mostra apenas o **UPLOAD_LOCATION** (disco local).  
- Ap√≥s atualizar, Immich gera novos `.immich` markers e refaz thumbnails automaticamente.  
- Revers√£o para 1.137.1 s√≥ √© poss√≠vel com backup da base de dados feito antes da migra√ß√£o.

---

## üîπ Pr√≥ximos passos

- Confirmar espa√ßo real do NAS:
  ```bash
  df -h /mnt/nas_media
  docker exec -it immich_server bash -lc 'df -h /ext'
  ```
- Rever estrat√©gia de backup autom√°tico (`pg_dump` + `rsync` di√°rio).
- Preparar migra√ß√£o controlada para v2.2.3 ap√≥s verifica√ß√£o do armazenamento.

---

**√öltima atualiza√ß√£o:** 2025-11-06  
**Autor:** Nuno (OinqServer)  
**Stack base:** [immich-app/immich](https://github.com/immich-app/immich)
